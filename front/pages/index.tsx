import type { NextPage } from 'next'
import Head from 'next/head'

import { useEffect, useState } from 'react'
import { Container, Form, Button} from 'react-bootstrap'
import { Controller, useForm } from "react-hook-form";
import Dupla from '../models/dupla';
import TransactionService from '../services/transaction';
import Select, { StylesConfig } from 'react-select';


const Index: NextPage = () => {
  const [cuenta, setCuenta] = useState<boolean>(true);
  const { register: regConCuenta, handleSubmit: handleSubmitConCuenta, formState: { errors : errorsConCuenta} } = useForm();
  const { control,register: regSinCuenta, handleSubmit: handleSubmitSinCuenta, formState: { errors : errorsSinCuenta} } = useForm();
  const [generos, setGeneros] = useState<Array<Dupla>>([]);

  // busqueda actores
  const [searchActor, setSearchActor] = useState<string|null>(null);
  const [actores, setActores] = useState<Array<Dupla>>([]);

  // busqueda directores
  const [searchDir, setSearchDir] = useState<string|null>(null);
  const [dir, setDir] = useState<Array<Dupla>>([]);

	useEffect(() => {
		// remueve la barra de navegacion del DOM en la pantalla de iniciar sesión
		let nav : HTMLElement|null= document.querySelector("#topnav");
		if (!!nav) {
			nav.remove();	
		}
    if (generos.length==0) {
      TransactionService.getGeneros().then((resp) =>{
        setGeneros(resp.data);
      }).catch((error)=>{
        console.log(error);
      });
    }
	}, []);
	
  const onSubmitSinCuenta = (data: any) => {
    data.genero_favorito = generos.map(x => x.id+"#"+ x.name).find(x => x.split("#")[0] == data.genero_favorito);
    data.actor_favorito = data.actor_favorito.value + "#" + data.actor_favorito.label ;
    data.dir_favorito = data.dir_favorito.value + "#" + data.dir_favorito.label ;
    console.log("data",data)
  }

  const onSubmitConCuenta = (data: any) => {
    console.log("data",data)
  }

  useEffect(() => {
    if (searchActor!=null) {
      TransactionService.getPersonas(searchActor).then((resp) =>{
          setActores(resp.data);
        }).catch((error)=>{
          console.log(error);
        });
    }
  }, [searchActor]);
  
  useEffect(() => {
    if (searchDir!=null) {
      TransactionService.getPersonas(searchDir).then((resp) =>{
          setDir(resp.data);
        }).catch((error)=>{
          console.log(error);
        });
    }
  }, [searchDir]);
  


  return (
    <>
      <Head>
        <title>Inicio</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      
      <div id='canvas'></div>

      <Container id='form-container' className='p-5'>
      
        <h3>Bienvenido!</h3>
          { cuenta &&
            <p style={{paddingBottom:"20px"}}>
              Inicie sesión si ya tiene una cuenta, o <span className='enlace' onClick={() => setCuenta(!cuenta)}>cree una nueva</span>.
            </p>
          }
          { !cuenta &&
            <p style={{paddingBottom:"20px"}}>
              LLene sus datos para crear su cuenta, o <span className='enlace' onClick={() => setCuenta(!cuenta)}>inicie sesión </span>
              si ya tiene una.
            </p>
          }

        { cuenta &&
          <Form className='forma-iniciar-sesion mt-4'  onSubmit={handleSubmitConCuenta(onSubmitConCuenta)}>


              <Form.Group className="mb-3 sesion-nombre" controlId="sesion-nombre">
                <Form.Label>Alias o correo electronico</Form.Label>
                <Form.Control type="text" style={{width:"280px"}}
                  {...regConCuenta("alias_correo", { required: true})}
                />
              </Form.Group>

              <Form.Group className="mb-3 sesion-password" controlId="sesion-password">
                <Form.Label>Contraseña</Form.Label>
                <Form.Control type="password" style={{width:"280px"}}
                  {...regConCuenta("password", { required: true})}
                />
              </Form.Group>

              <Button  type="submit">Enviar</Button>

          </Form>
        }

        { !cuenta &&
          <Form className='mt-4' onSubmit={handleSubmitSinCuenta(onSubmitSinCuenta)}>
            <h4 className='my-4'>Datos de la cuenta</h4>
            <div className='forma-crear-cuenta'>

              <Form.Group className="mb-3 input-sincuenta forma-nombre" controlId="forma-nombre">
                <Form.Label>Nombre de usuario</Form.Label>
                <Form.Control type="text" style={{width:"280px"}}
                  {...regSinCuenta("nombre", { required: true})}
                />
              </Form.Group>

              <Form.Group className="mb-3 input-sincuenta apellido1" controlId="apellido1">
                <Form.Label>Apellido Paterno</Form.Label>
                <Form.Control type="text" style={{width:"280px"}}
                  {...regSinCuenta("apellido1", { required: true})}
                />
              </Form.Group>

              <Form.Group className="mb-3 input-sincuenta apellido2" controlId="apellido2">
                <Form.Label>Apellido Materno</Form.Label>
                <Form.Control type="text" style={{width:"280px"}}
                  {...regSinCuenta("apellido2", { required: true})}
                />
              </Form.Group>

              <Form.Group className="mb-3 input-sincuenta forma-correo" controlId="forma-correo">
                <Form.Label>Correo</Form.Label>
                <Form.Control type="email" style={{width:"280px"}}
                  {...regSinCuenta("email", { required: true})}
                />
              </Form.Group>

              <Form.Group className="mb-3 input-sincuenta forma-alias" controlId="forma-alias">
                <Form.Label>Alias</Form.Label>
                <Form.Control type="text" style={{width:"280px"}}
                  {...regSinCuenta("alias", { required: true})}
                />
              </Form.Group>

              <Form.Group className="mb-3 input-sincuenta forma-edad" controlId="forma-edad">
                <Form.Label>Edad</Form.Label>
                <Form.Control type="number" style={{width:"280px"}} step="1" min="0" max="99"
                  {...regSinCuenta("edad", { required: true, pattern: /^[0-9]+$/i })}
                />
              </Form.Group>

              <Form.Group className="mb-3 input-sincuenta forma-edad" controlId="forma-genero">
                <Form.Label>Género</Form.Label>
                <Form.Select aria-label="Default select example" style={{width:"280px"}}
                  {...regSinCuenta("genero", { required: true})}
                >
                  <option>Selecciona una opción</option>
                  <option value="F">Femenino</option>
                  <option value="M">Masculino</option>
                </Form.Select>
              </Form.Group>

              <Form.Group className="mb-3 input-sincuenta forma-password1" controlId="forma-password1">
                <Form.Label>Contraseña</Form.Label>
                <Form.Control type="password" style={{width:"280px"}} 
                  {...regSinCuenta("password1", { required: true})}
                />
              </Form.Group>

              <Form.Group className="mb-3 input-sincuenta forma-password2" controlId="forma-password2">
                <Form.Label>Confirmar Contraseña</Form.Label>
                <Form.Control type="password" style={{width:"280px"}}
                  {...regSinCuenta("password2", { required: true})}
                />
              </Form.Group>
            </div>

            <hr />

            <h4 className='my-4'>Tus Preferencias cinéfilas</h4>

            <div className='forma-crear-cuenta'>

              <Form.Group className="mb-3 input-sincuenta pref-genero" controlId="pref-genero">
                <Form.Label>Selecciona tú género favorito</Form.Label>
                <Form.Select aria-label="Default select example" style={{width:"280px"}}
                  {...regSinCuenta("genero_favorito", { required: true})}
                >
                  <option>Selecciona una opción</option>
                  {
                    generos.map((genero)=>{
                      return <option key={genero.id} value={genero.id}>{genero.name}</option>
                    })
                  }
                </Form.Select>
              </Form.Group>

              <Form.Group className="mb-3 input-sincuenta pref-genero" controlId="pref-genero">
                <Form.Label>Selecciona tú actor favorito</Form.Label>
                <Controller
                  name="actor_favorito"
                  control={control}
                  render={({ field }) => 
                    <Select 
                      {...field} 
                      onInputChange={(value)=> setSearchActor(value.replaceAll(/\s+/g,"+"))}
                      className="select-react"
                      isSearchable={true}
                      options=
                      {
                        actores.map((persona: Dupla) =>{
                          return {label:persona.name, value: persona.id}
                        })
                      }
                      styles={{
                        option: (provided, state) => ({
                          ...provided,
                          borderBottom: '1px dotted pink',
                          color: state.isSelected ? 'white' : 'black',
                          padding: 6,
                        })
                      }}
                    />
                  }
                />
              </Form.Group>

              <Form.Group className="mb-3 input-sincuenta pref-genero" controlId="pref-genero">
                <Form.Label>Selecciona tú director favorito</Form.Label>
                <Controller
                  name="dir_favorito"
                  control={control}
                  render={({ field }) => 
                    <Select 
                      {...field} 
                      className="select-react"
                      onInputChange={(value)=> setSearchDir(value.replaceAll(/\s+/g,"+"))}
                      isSearchable={true}
                      options=
                      {
                        dir.map((persona: Dupla) =>{
                          return {label:persona.name, value: persona.id}
                        })
                      }
                      styles={{
                        option: (provided, state) => ({
                          ...provided,
                          borderBottom: '1px dotted pink',
                          color: state.isSelected ? 'white' : 'black',
                          padding: 6,
                        })
                      }}
                    />
                  }
                />
              </Form.Group>

            </div>

            <Button  className='my-4' type="submit">Enviar</Button>

          </Form>
        }

      </Container>

    </>
  )
}

export default Index;
